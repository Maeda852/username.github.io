<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>出社受付</title>
<style>
body {
  font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN";
  padding:16px;
  max-width:640px;
  margin:auto;
}
input, button {
  font-size:16px;
  padding:10px;
  width:100%;
  margin-top:8px;
}
#cardInfo {
  margin-top:12px;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>
<h1>出社受付</h1>

<input list="namelist" id="nameInput" placeholder="氏名を入力" autocomplete="off" />
<datalist id="namelist"></datalist>

<button id="assignBtn">カード割当</button>
<div id="cardInfo"></div>

<button id="nextBtn" style="display:none;">次へ</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1xzsz9IDoku5vEY2wrMZzBiz34biTVfx98sUan4wNIwE/edit?usp=sharing";
const gasUrl = "https://script.google.com/macros/s/AKfycby9bW6yQI5ISExInd1B4YaSM2dnbxDGZWiuMJd9gr83tEWY4ddXFjc08Xb_Mfk89lOO/exec";
const googleFormBase =
  "https://docs.google.com/forms/d/e/XXXX/viewform?usp=pp_url";

const entryName = "entry.1288388977";
const entryCard = "entry.352252719";
const entryDept = "entry.1018926610";

const params = new URLSearchParams(location.search);
const shift = params.get("shift") || "day";

let employees = [];
let assigned = null;

function normalize(s){
  return (s||"").replace(/\s+/g,"").toLowerCase();
}

fetch(csvUrl)
  .then(r=>r.text())
  .then(t=>{
    const data = Papa.parse(t,{header:true}).data;
    employees = data.filter(r=>r.name);
    const dl = document.getElementById("namelist");
    employees.forEach(e=>{
      const o = document.createElement("option");
      o.value = e.name;
      dl.appendChild(o);
    });
  });

function findEmp(name){
  return employees.find(e=>normalize(e.name)===normalize(name));
}

document.getElementById("assignBtn").onclick = async () => {
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return alert("氏名を入力してください");

  const emp = findEmp(name);
  const dept = emp?.department || "";

  const url =
    `${gasUrl}?shift=${shift}&department=${encodeURIComponent(dept)}&name=${encodeURIComponent(name)}`;

  const res = await fetch(url).then(r=>r.json());

  if(res.error){
    alert(res.error);
    return;
  }

  assigned = {
    name: name,
    card: res.cardNo,
    dept: res.department
  };

  document.getElementById("cardInfo").textContent =
    `カード番号：${assigned.card} ／ 部署：${assigned.dept || "ALL"}`;

  document.getElementById("nextBtn").style.display = "block";
};

document.getElementById("nextBtn").onclick = () => {
  const q =
    `${entryName}=${encodeURIComponent(assigned.name)}` +
    `&${entryCard}=${encodeURIComponent(assigned.card)}` +
    `&${entryDept}=${encodeURIComponent(assigned.dept)}`;

  location.href = googleFormBase + "&" + q;
};
</script>
</body>
</html>


