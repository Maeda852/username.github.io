<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>出社受付</title>
<style>
body {
  font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN";
  padding:16px;
  max-width:640px;
  margin:auto;
}
input, button {
  font-size:16px;
  padding:10px;
  width:100%;
  margin-top:8px;
}
#cardInfo {
  margin-top:12px;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>
<h1>出社受付</h1>

<input list="namelist" id="nameInput" placeholder="氏名を入力" autocomplete="off" />
<datalist id="namelist"></datalist>

<button id="assignBtn">カード割当</button>
<div id="cardInfo"></div>

<button id="nextBtn" style="display:none;">次へ</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
// ===== 設定 =====
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpGDiZD4OrEiEzIh4DMRN0eFbHkBGZSnxewenjI-jnTstC1U07dQ0mfvNBM5KW9M88tL5fqQ8fyLWy/pub?output=csv";
const gasUrl = "https://script.google.com/macros/s/AKfycbyUrbt7ioZSMTK2xdaKteg7-goRp0wiUhSIsi_jTR5R4j1hdPzl7LVW_LSZ15ZWuVcL/exec";

const googleFormBase =
  "https://docs.google.com/forms/d/e/1FAIpQLSfCHO8Ic_LePLxIXwTunyZGOh6WH2heDERT0ycrCDUUO0mUBg/viewform?usp=pp_url";

const entryName   = "entry.1288388977";
const entryCard   = "entry.352252719";
const entryDept   = "entry.1018926610";
const entryAgency = "entry.703933889";

// ===== 共通 =====
const params = new URLSearchParams(location.search);
const shift = params.get("shift") || "day";

let employees = [];
let assigned = null;

function normalize(s){
  return (s||"").replace(/\s+/g,"").toLowerCase();
}

// ===== CSV 読み込み =====
fetch(csvUrl)
  .then(r => r.text())
  .then(t => {
    const data = Papa.parse(t, { header:true }).data;
    employees = data.filter(r => r.name);

    const dl = document.getElementById("namelist");
    employees.forEach(e => {
      const o = document.createElement("option");
      o.value = e.name;
      dl.appendChild(o);
    });
  });

// ===== カード割当 =====
document.getElementById("assignBtn").onclick = async () => {
  const name = document.getElementById("nameInput").value.trim();
  if(!name){
    alert("氏名を入力してください");
    return;
  }

  const emp = employees.find(e => normalize(e.name) === normalize(name));
  const dept   = emp?.department || "";
  const agency = emp?.agency || "";

  const url =
    `${gasUrl}?shift=${shift}` +
    `&department=${encodeURIComponent(dept)}` +
    `&name=${encodeURIComponent(name)}`;

  const res = await fetch(url).then(r => r.json());

  if(res.error){
    alert(res.error);
    return;
  }

  assigned = {
    name,
    card: res.cardNo,
    dept: res.department,
    agency,
    baggageValuable: res.baggageValuable,
    baggageHand: res.baggageHand,
    guideUrl: res.guideUrl   // ★ 追加
  };

  document.getElementById("cardInfo").innerHTML =
    `カード番号：${assigned.card}<br>` +
    `部署：${assigned.dept}<br>` +
    `会社：${assigned.agency || "-"}<br><br>` +
    `<strong>貴重品：</strong>${assigned.baggageValuable || "受付確認"}<br>` +
    `<strong>手荷物：</strong>${assigned.baggageHand || "受付確認"}`;

  document.getElementById("nextBtn").style.display = "block";
};

// ===== 次へ =====
document.getElementById("nextBtn").onclick = () => {
  if(!assigned) return;

  // ★ guide_url があれば最優先
  if (assigned.guideUrl) {
    location.href = assigned.guideUrl;
    return;
  }

  // ★ 無ければ従来通り Googleフォーム
  const q =
    `${entryName}=${encodeURIComponent(assigned.name)}` +
    `&${entryCard}=${encodeURIComponent(assigned.card)}` +
    `&${entryDept}=${encodeURIComponent(assigned.dept)}` +
    `&${entryAgency}=${encodeURIComponent(assigned.agency)}`;

  location.href = googleFormBase + "&" + q;
};
</script>
</body>
</html>
