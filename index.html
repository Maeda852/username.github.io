<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>出社受付</title>
<style>
body {
  font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN";
  padding:16px;
  max-width:640px;
  margin:auto;
}
input, button {
  font-size:16px;
  padding:10px;
  width:100%;
  margin-top:8px;
}
button {
  cursor: pointer;
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
#cardInfo {
  margin-top:12px;
  font-size:18px;
  font-weight:bold;
}
.notice {
  margin-top:12px;
  padding:12px;
  border:2px solid #333;
  border-radius:8px;
  background:#f9f9f9;
  font-size:16px;
}
#errorBox {
  margin-top:16px;
  padding:16px;
  border:3px solid #c00;
  border-radius:8px;
  background:#fff0f0;
  font-size:18px;
  font-weight:bold;
  display:none;
}
</style>
</head>

<body>
<h1>出社受付</h1>

<div id="main">
  <input list="namelist" id="nameInput" placeholder="氏名を入力" autocomplete="off" />
  <datalist id="namelist"></datalist>

  <button id="assignBtn">カード割当</button>

  <div id="cardInfo"></div>

  <div id="notice" class="notice" style="display:none;">
    この画面を<strong>受付担当者に見せてください</strong><br><br>
    荷物の預け方が分からない方は「次へ」を押してください。<br>
    案内が不要な方は、この画面を閉じて大丈夫です。
  </div>

  <button id="nextBtn" style="display:none;">次へ</button>
</div>

<div id="errorBox"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
// ===== 設定 =====
const csvUrl =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpGDiZD4OrEiEzIh4DMRN0eFbHkBGZSnxewenjI-jnTstC1U07dQ0mfvNBM5KW9M88tL5fqQ8fyLWy/pub?output=csv";

const gasUrl =
  "https://script.google.com/macros/s/AKfycbygF5HXSpdK1au7z_Gj3y_vtPBLEC-ygrxzTbAISngrlmBvKCR6q0E17y0NTaqewyUa/exec";

const googleFormBase =
  "https://docs.google.com/forms/d/e/1FAIpQLSfCHO8Ic_LePLxIXwTunyZGOh6WH2heDERT0ycrCDUUO0mUBg/viewform?usp=pp_url";

const entryName   = "entry.1288388977";
const entryCard   = "entry.352252719";
const entryDept   = "entry.1018926610";
const entryAgency = "entry.703933889";

// ===== 共通 =====
const params = new URLSearchParams(location.search);
const shift = params.get("shift") || "day";

let employees = [];
let assigned = null;

// 空白除去＋小文字
function normalize(s){
  return (s || "").replace(/[\s　]+/g, "").toLowerCase();
}

// エラー表示（受付OFFなど）
function showError(msg){
  document.getElementById("main").style.display = "none";
  const box = document.getElementById("errorBox");
  box.innerHTML = msg;
  box.style.display = "block";
}

// ===== CSV 読み込み =====
fetch(csvUrl)
  .then(r => r.text())
  .then(t => {
    const data = Papa.parse(t, { header:true }).data;
    employees = data.filter(r => r.name);

    const dl = document.getElementById("namelist");
    employees.forEach(e => {
      const o = document.createElement("option");
      o.value = e.name;
      dl.appendChild(o);
    });
  });

// ===== カード割当 =====
document.getElementById("assignBtn").onclick = async () => {
  const rawName = document.getElementById("nameInput").value.trim();
  if (!rawName) {
    alert("氏名を入力してください");
    return;
  }

  const sendName = normalize(rawName);
  const emp = employees.find(e => normalize(e.name) === sendName);

  if (!emp) {
    alert("名簿に存在しない氏名です。\n受付で確認してください。");
    return;
  }

  const dept      = emp?.department || "";
  const agency    = emp?.agency || "";
  const fixedCard = String(emp?.idcard || "").trim();

  const url =
    `${gasUrl}?shift=${shift}` +
    `&name=${encodeURIComponent(sendName)}` +
    `&department=${encodeURIComponent(dept)}` +
    (fixedCard ? `&card=${encodeURIComponent(fixedCard)}` : "");

  const res = await fetch(url).then(r => r.json());

  // ===== 受付OFF =====
  if (res.error === "reception_closed") {
    showError("現在は受付時間外です。<br>受付担当者にお声がけください。");
    return;
  }

  if (res.error) {
    alert(res.error);
    return;
  }

  assigned = {
    name: sendName,
    displayName: rawName,
    card: fixedCard || res.cardNo,
    dept,
    agency,
    baggageValuable: res.baggageValuable,
    baggageHand: res.baggageHand,
    guideUrl: res.guideUrl
  };

  document.getElementById("cardInfo").innerHTML =
    `氏名：${assigned.displayName}<br>` +
    `カード番号：${assigned.card}<br>` +
    `部署：${assigned.dept || "未登録"}<br>` +
    `会社：${assigned.agency || "未登録"}<br><br>` +
    `<strong>貴重品：</strong>${assigned.baggageValuable || "受付確認"}<br>` +
    `<strong>手荷物：</strong>${assigned.baggageHand || "受付確認"}`;

  document.getElementById("notice").style.display = "block";
  document.getElementById("nextBtn").style.display = "block";
};

// ===== 次へ =====
document.getElementById("nextBtn").onclick = () => {
  if (!assigned) return;

  if (assigned.guideUrl) {
    location.href = assigned.guideUrl;
    return;
  }

  const q =
    `${entryName}=${encodeURIComponent(assigned.name)}` +
    `&${entryCard}=${encodeURIComponent(assigned.card)}` +
    `&${entryDept}=${encodeURIComponent(assigned.dept)}` +
    `&${entryAgency}=${encodeURIComponent(assigned.agency)}`;

  location.href = googleFormBase + "&" + q;
};
</script>
</body>
</html>
